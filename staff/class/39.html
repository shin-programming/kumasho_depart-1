<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>熊商デパート ３年９組　完売報告用フォーム</title>
        <link rel="stylesheet" href="class_style.css">
    </head>
    <body>
        <div class="tab-bar" style="display: flex; align-items: flex-start;">
            <div style="display: flex; flex-direction: column; align-items: flex-start; width: 100%;">
                <h1 style="margin: 0;">３年９組　【株式会社　西川商店　熊デパ本店】　完売報告用フォーム</h1>
                <div class = "product-sold-caption" id="product-count-area" style="margin:4px 0 0 0;font-weight:bold; display:block;">
                    商品数：<span id="pd">0</span>
                     ／ 完売数：<span id="sold-out">0</span>
                </div>
            </div>
        </div>
        <div id="loading" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
            <div class="spinner" style="border:8px solid #eee;border-top:8px solid #2196f3;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;"></div>
        </div>
        <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        </style>
        <script>
            // ログイン時にlocalStorageへ 'isLoggedIn39' を保存している前提
            if (!localStorage.getItem('isLoggedIn39')) {
                window.location.href = '../home/home.html';
            }
            // ページ描画後にイベント登録・データ取得
            window.addEventListener('DOMContentLoaded', async function() {
                    
                // 1年: 11~19, 2年: 21~29, 3年: 31~39 のログイン情報を削除（毎回リセット）
                //for (let g = 1; g <= 3; g++) { // 学年ごとに 例: g=3
                    //for (let c = 1; c <= 9; c++) { // 1組から9組まで 例: c=9
                        //localStorage.removeItem(`isLoggedIn${g}${c}`); // ログイン情報を消す 例: localStorage["isLoggedIn39"] を削除
                    //}
                //}
                
                // ログアウト処理
                document.querySelector('.logout-button').addEventListener('click', function() {
                    localStorage.removeItem('isLoggedIn39');
                    window.location.href = '../home/home.html';
                });
                // ローディング表示
                document.getElementById('loading').style.display = 'flex';
                const className = "3-9";
                const gas_url = "https://script.google.com/macros/s/AKfycbwX9IxU0Hj1F2ab2TfX9Fe20zMIlzF2zrhBE5aG3rb9Uw9bKuCwELbJ1dThhafvNRrGlA/exec?sheet=" + encodeURIComponent(className);
                fetch(gas_url)
                    .then(response => response.json())
                    .then(data => {
                        console.log("3-9デバッグ情報:");
                        console.log(data);
                        console.log(`pd: ${data[0].pd}`);
                        console.log(`sold_out: ${data[0].sold_out}`);
                        document.getElementById("pd").textContent = data[0].pd;
                        document.getElementById("sold-out").textContent = data[0].sold_out;

                        // 商品テーブル生成
                        const table = document.getElementById('product-table');
                        // ヘッダー
                        table.innerHTML = `<thead><tr><th>商品名</th><th>販売価格</th><th>販売状況</th></tr></thead><tbody></tbody>`;
                        const tbody = table.querySelector('tbody');
                        // データ行
                        data.slice(1).forEach(item => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${item.pdname || '"商品名が読み込めませんでした"'}</td><td>¥${item.price || '"商品価格が読み込めませんでした"'}</td><td>${item.sales || '"販売状況が読み込めませんでした"'}</td>`;
                            tbody.appendChild(tr);
                        });
                    })
                    .finally(() => {
                        document.getElementById('loading').style.display = 'none';
                    });
            });
        </script>
        <br>
        <table class = "product-table" id="product-table">
            <!-- JSでヘッダー・データ行を生成 -->
        </table>
        <div>
            <button class="logout-button">ログアウト</button>
        </div>
    </body>
</html>